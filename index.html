<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Álbum - Subir fotos y videos</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#60a5fa;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter, system-ui, Arial, sans-serif;
    background:linear-gradient(180deg,#071028 0%, #061226 100%); color:#e6eef6;
    padding:18px;
  }
  header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
  h1{font-size:20px;margin:0}
  .toolbar{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{
    background:linear-gradient(180deg,var(--card),#07162a); border:1px solid rgba(255,255,255,0.04);
    color:inherit;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;
  }
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04)}
  main{display:grid;grid-template-columns:360px 1fr;gap:18px}
  /* uploader */
  .uploader{background:var(--glass);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .drop{border:2px dashed rgba(255,255,255,0.03); padding:16px;border-radius:10px;text-align:center;min-height:130px;display:flex;flex-direction:column;justify-content:center;gap:8px}
  input[type=file]{display:none}
  label.filelabel{cursor:pointer}
  .fields{display:grid;gap:8px;margin-top:10px}
  .fields input[type=text], .fields textarea, .fields select{
    width:100%; padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);
    background:transparent;color:inherit;
  }
  .small{font-size:13px;color:var(--muted)}
  .previewRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .preview{width:80px;height:80px;background:#071126;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;position:relative}
  .preview img, .preview video{width:100%;height:100%;object-fit:cover}
  .meta{margin-top:8px;font-size:13px;color:var(--muted)}
  /* gallery */
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .search{flex:1}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
  .card{background:linear-gradient(180deg,#071226 0%, #061427 100%);padding:8px;border-radius:10px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,0.03)}
  .thumb{width:100%;height:120px;display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:8px;background:#081224}
  .thumb img, .thumb video{width:100%;height:100%;object-fit:cover;display:block}
  .title{font-size:13px;margin-top:6px;font-weight:700}
  .desc{font-size:12px;color:var(--muted);max-height:36px;overflow:hidden}
  .card .actions{display:flex;gap:6px;margin-top:8px}
  .pill{font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;padding:18px;z-index:60}
  .modal.open{display:flex}
  .modal .inner{background:#030611;padding:14px;border-radius:12px;max-width:1100px;max-height:90vh;overflow:auto;width:100%}
  .modal-media{display:flex;gap:12px;align-items:flex-start}
  .modal-media .big{flex:1;min-height:320px;background:#000;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .modal-media video, .modal-media img{width:100%;height:100%;object-fit:contain}
  .modal-info{width:320px}
  .muted{color:var(--muted)}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
  @media (max-width:900px){ main{grid-template-columns:1fr} .modal-media{flex-direction:column} .modal-info{width:100%} .thumb{height:140px} }
</style>
</head>
<body>
<header>
  <div>
    <h1>Álbum — Fotos y Videos</h1>
    <div class="small">Sube, organiza y etiqueta tus archivos en el navegador (guardado local).</div>
  </div>
  <div class="toolbar">
    <button class="btn" id="exportBtn" title="Descargar archivos seleccionados o todos">Descargar</button>
    <button class="btn ghost" id="clearAll">Borrar todo</button>
  </div>
</header>

<main>
  <section class="uploader">
    <h3>Subir archivos</h3>
    <div class="drop" id="dropZone">
      <div class="small">Arrastra y suelta imágenes o videos aquí — o</div>
      <label class="filelabel btn" for="fileInput">Seleccionar archivos</label>
      <input id="fileInput" type="file" accept="image/*,video/*" multiple />
      <div class="small" id="hint">Soporta JPG/PNG/WEBP/GIF y MP4, WebM. Los archivos se guardan en tu navegador.</div>
    </div>

    <div class="fields">
      <input id="titleInput" type="text" placeholder="Título general (opcional)" />
      <textarea id="descInput" rows="3" placeholder="Descripción general (opcional)"></textarea>
      <select id="visibility">
        <option value="private">Privado (local)</option>
        <option value="public">Público (compartir con link) — nota: sigue en tu navegador</option>
      </select>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="addBtn" class="btn">Agregar archivos al álbum</button>
        <div class="small" style="margin-left:auto">Total guardados: <span id="count">0</span></div>
      </div>
    </div>

    <div class="previewRow" id="previewRow" aria-hidden="false"></div>
  </section>

  <section>
    <div class="controls">
      <input class="search" id="search" placeholder="Buscar por título o descripción..." />
      <select id="filter">
        <option value="all">Todo</option>
        <option value="image">Solo imágenes</option>
        <option value="video">Solo videos</option>
      </select>
      <button class="btn" id="refresh">Refrescar</button>
    </div>

    <div class="grid" id="gallery"></div>
  </section>
</main>

<!-- modal -->
<div class="modal" id="modal" role="dialog" aria-hidden="true">
  <div class="inner">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong id="modalTitle">Detalle</strong>
      <div>
        <button class="btn" id="downloadBtn">Descargar</button>
        <button class="btn ghost" id="closeModal">Cerrar</button>
      </div>
    </div>
    <div class="modal-media">
      <div class="big" id="modalMedia"></div>
      <div class="modal-info">
        <div style="margin-bottom:12px"><strong>Título</strong><div id="modalT" class="muted"></div></div>
        <div style="margin-bottom:12px"><strong>Descripción</strong><div id="modalD" class="muted"></div></div>
        <div style="margin-bottom:12px"><strong>Tipo</strong><div id="modalType" class="pill muted"></div></div>
        <div style="margin-bottom:12px"><strong>Fecha</strong><div id="modalDate" class="muted"></div></div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn" id="deleteBtn">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  Nota: Los archivos quedan guardados en el navegador (IndexedDB). Si borras datos del navegador, pierdes el álbum. Para moverlo, descarga los archivos.
</footer>

<script>
/* ---------- Simple IndexedDB wrapper ---------- */
const DB_NAME = 'album-db-v1';
const STORE = 'media';
let db;

function openDB(){
  return new Promise((res, rej)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      db = e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        const st = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
        st.createIndex('type', 'type', {unique:false});
        st.createIndex('title', 'title', {unique:false});
        st.createIndex('desc', 'desc', {unique:false});
        st.createIndex('date', 'date', {unique:false});
      }
    };
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror = e => rej(e);
  });
}

function addMediaItem(item){
  return new Promise((res, rej)=>{
    const tx = db.transaction(STORE,'readwrite'); const store = tx.objectStore(STORE);
    const r = store.add(item);
    r.onsuccess = ()=>res(r.result);
    r.onerror = e=>rej(e);
  });
}
function getAllItems(){
  return new Promise((res, rej)=>{
    const tx = db.transaction(STORE,'readonly'); const store = tx.objectStore(STORE);
    const req = store.getAll();
    req.onsuccess = ()=>res(req.result);
    req.onerror = e=>rej(e);
  });
}
function deleteItem(id){
  return new Promise((res, rej)=>{
    const tx = db.transaction(STORE,'readwrite'); const store = tx.objectStore(STORE);
    const r = store.delete(id);
    r.onsuccess = ()=>res();
    r.onerror = e=>rej(e);
  });
}
function clearAll(){
  return new Promise((res, rej)=>{
    const tx = db.transaction(STORE,'readwrite'); const store = tx.objectStore(STORE);
    const r = store.clear();
    r.onsuccess = ()=>res();
    r.onerror = e=>rej(e);
  });
}

/* ---------- UI and logic ---------- */
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const previewRow = document.getElementById('previewRow');
const addBtn = document.getElementById('addBtn');
const titleInput = document.getElementById('titleInput');
const descInput = document.getElementById('descInput');
const gallery = document.getElementById('gallery');
const countSpan = document.getElementById('count');
const searchInput = document.getElementById('search');
const filterSelect = document.getElementById('filter');
const refreshBtn = document.getElementById('refresh');
const exportBtn = document.getElementById('exportBtn');
const clearAllBtn = document.getElementById('clearAll');

let stagedFiles = []; // {file, url, type}

function humanDate(ts){ return new Date(ts).toLocaleString(); }

/* drag/drop */
['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev,e=>{ e.preventDefault(); dropZone.style.borderColor='#60a5fa'; }));
['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,e=>{ e.preventDefault(); dropZone.style.borderColor=''; }));
dropZone.addEventListener('drop', e=>{
  const f = Array.from(e.dataTransfer.files || []);
  handleFiles(f);
});

fileInput.addEventListener('change', ()=> {
  handleFiles(Array.from(fileInput.files));
  fileInput.value = '';
});

function handleFiles(files){
  const allowed = files.filter(f => f.type.startsWith('image/') || f.type.startsWith('video/'));
  allowed.forEach(f=>{
    const url = URL.createObjectURL(f);
    stagedFiles.push({file:f, url, type: f.type.startsWith('image/') ? 'image' : 'video'});
  });
  renderStaged();
}

/* render staged previews */
function renderStaged(){
  previewRow.innerHTML = '';
  stagedFiles.forEach((s, i)=>{
    const el = document.createElement('div'); el.className='preview';
    if(s.type==='image'){
      const img = document.createElement('img'); img.src = s.url; el.appendChild(img);
    } else {
      const v = document.createElement('video'); v.src = s.url; v.muted = true; v.playsInline = true; v.onmouseenter = ()=>v.play(); v.onmouseleave = ()=>v.pause();
      el.appendChild(v);
    }
    const del = document.createElement('button'); del.textContent='✖'; del.title='Quitar'; del.style.position='absolute'; del.style.right='6px'; del.style.top='6px'; del.style.background='rgba(0,0,0,0.4)'; del.style.border='none'; del.style.color='#fff'; del.style.borderRadius='6px'; del.style.cursor='pointer';
    del.addEventListener('click', ()=>{ URL.revokeObjectURL(s.url); stagedFiles.splice(i,1); renderStaged(); });
    el.appendChild(del);
    previewRow.appendChild(el);
  });
}

/* add to DB */
addBtn.addEventListener('click', async ()=>{
  if(stagedFiles.length===0){ alert('No hay archivos seleccionados.'); return; }
  const baseTitle = titleInput.value.trim();
  const baseDesc = descInput.value.trim();
  addBtn.disabled = true;
  for(const s of stagedFiles){
    const blob = s.file; // keep original blob to store
    const item = {
      title: baseTitle || s.file.name,
      desc: baseDesc || '',
      type: s.type,
      date: Date.now(),
      filename: s.file.name,
      blob: blob
    };
    try{
      await addMediaItem(item);
    } catch(err){
      console.error('Error guardando:', err);
      alert('Error guardando en IndexedDB. Revisa consola.');
    }
  }
  stagedFiles.forEach(s=>URL.revokeObjectURL(s.url));
  stagedFiles = [];
  titleInput.value=''; descInput.value='';
  await refreshGallery();
  addBtn.disabled = false;
});

/* gallery rendering */
async function refreshGallery(){
  const items = await getAllItems();
  countSpan.textContent = items.length;
  renderGallery(items);
}

function renderGallery(items){
  const q = searchInput.value.trim().toLowerCase();
  const filter = filterSelect.value;
  let list = items.slice().sort((a,b)=>b.date - a.date);
  if(q) list = list.filter(i => (i.title || '').toLowerCase().includes(q) || (i.desc||'').toLowerCase().includes(q));
  if(filter==='image') list = list.filter(i=>i.type==='image');
  if(filter==='video') list = list.filter(i=>i.type==='video');
  gallery.innerHTML = '';
  if(list.length===0){ gallery.innerHTML = '<div class="muted">No hay elementos que mostrar.</div>'; return; }
  list.forEach(item=>{
    const card = document.createElement('div'); card.className='card';
    const thumb = document.createElement('div'); thumb.className='thumb';
    // create objectURL from blob
    const url = URL.createObjectURL(item.blob);
    if(item.type==='image'){
      const img = document.createElement('img'); img.src=url; thumb.appendChild(img);
    } else {
      const v = document.createElement('video'); v.src=url; v.muted=true; v.playsInline=true; v.onmouseenter=()=>v.play(); v.onmouseleave=()=>v.pause(); thumb.appendChild(v);
    }
    card.appendChild(thumb);
    const t = document.createElement('div'); t.className='title'; t.textContent = item.title || item.filename;
    const d = document.createElement('div'); d.className='desc'; d.textContent = item.desc || '';
    const actions = document.createElement('div'); actions.className='actions';
    const viewBtn = document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='Ver';
    viewBtn.addEventListener('click', ()=>openModal(item));
    const dlBtn = document.createElement('button'); dlBtn.className='btn ghost'; dlBtn.textContent='Desc';
    dlBtn.addEventListener('click', ()=>downloadBlob(item));
    const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Eliminar';
    delBtn.addEventListener('click', async ()=>{ if(confirm('Eliminar este archivo?')){ await deleteItem(item.id); await refreshGallery(); }});
    actions.appendChild(viewBtn); actions.appendChild(dlBtn); actions.appendChild(delBtn);
    card.appendChild(t); card.appendChild(d); card.appendChild(actions);
    gallery.appendChild(card);
    // revoke URL after some time to avoid leaks
    setTimeout(()=>URL.revokeObjectURL(url), 60*1000);
  });
}

/* modal */
const modal = document.getElementById('modal');
const modalMedia = document.getElementById('modalMedia');
const modalT = document.getElementById('modalT');
const modalD = document.getElementById('modalD');
const modalType = document.getElementById('modalType');
const modalDate = document.getElementById('modalDate');
const downloadBtn = document.getElementById('downloadBtn');
const deleteBtn = document.getElementById('deleteBtn');
const closeModal = document.getElementById('closeModal');
let currentItem = null;

function openModal(item){
  currentItem = item;
  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
  modalT.textContent = item.title || item.filename;
  modalD.textContent = item.desc || '(sin descripción)';
  modalType.textContent = item.type;
  modalDate.textContent = humanDate(item.date || 0);
  modalMedia.innerHTML = '';
  const url = URL.createObjectURL(item.blob);
  if(item.type==='image'){
    const img = document.createElement('img'); img.src=url; modalMedia.appendChild(img);
  } else {
    const v = document.createElement('video'); v.src=url; v.controls = true; v.autoplay = true; modalMedia.appendChild(v);
  }
  downloadBtn.onclick = ()=>downloadBlob(item);
  deleteBtn.onclick = async ()=>{
    if(!confirm('Eliminar este archivo?')) return;
    await deleteItem(item.id);
    closeModalFunc();
    await refreshGallery();
  };
}

function closeModalFunc(){ currentItem = null; modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); modalMedia.innerHTML=''; }
closeModal.addEventListener('click', closeModalFunc);
modal.addEventListener('click', e => { if(e.target===modal) closeModalFunc(); });

/* download blob simple */
function downloadBlob(item){
  const url = URL.createObjectURL(item.blob);
  const a = document.createElement('a'); a.href = url; a.download = item.filename || ('media.' + (item.type==='image'?'jpg':'mp4'));
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

/* export button: download all as individual files in a zip is complex client-side without libs.
   We'll prompt to download each one sequentially (ask confirm). */
exportBtn.addEventListener('click', async ()=>{
  const items = await getAllItems();
  if(items.length===0){ alert('No hay archivos para descargar.'); return; }
  if(!confirm('Descargar todos los archivos guardados (se iniciará la descarga uno a uno)?')) return;
  for(const it of items){
    downloadBlob(it);
    // small delay so browser can handle multiple downloads (can't guarantee)
    await new Promise(r=>setTimeout(r, 600));
  }
});

/* clear all */
clearAllBtn.addEventListener('click', async ()=>{
  if(!confirm('Borrar todo el álbum? Esto eliminará permanentemente los archivos en este navegador.')) return;
  await clearAll();
  await refreshGallery();
});

/* search & filter */
searchInput.addEventListener('input', ()=>refreshGallery());
filterSelect.addEventListener('change', ()=>refreshGallery());
refreshBtn.addEventListener('click', ()=>refreshGallery());

/* init */
(async ()=>{
  await openDB();
  await refreshGallery();
})();

/* keyboard shortcuts: Ctrl+K focus search */
document.addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); searchInput.focus(); searchInput.select(); }
});
</script>
</body>
</html>
